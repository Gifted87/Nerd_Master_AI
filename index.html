<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gifted's AI Chat</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="overlay hidden" id="verify-email-overlay">
      <div class="overlay__container verify-email">
        <p class="verify-email__text" id="verify_email_text">
          Please verify your email before continuing
        </p>
        <button class="verify-email__close-button" id="close-verify-email">
          Close
        </button>
      </div>
    </div>
    <div class="app-container hidden" id="chat-app">
      <aside class="sidebar" id="chat-sidebar">
        <div class="sidebar__header">
          <h2 class="sidebar__site-title">Conversations</h2>
        </div>
        <nav class="sidebar__nav">
          <ul class="sidebar__conversation-list" id="conversation-list">
            <!-- Conversation list items will be loaded here -->
          </ul>
        </nav>
      </aside>
      <main class="chat-area">
        <header class="chat-header">
          <button
            class="sidebar-toggle-button"
            id="sidebar-toggle"
            aria-label="Toggle conversations menu"
          >
            <i class="fas fa-bars"></i>
          </button>
          <h1 class="chat-header__title">Gee-Pee</h1>
          <div class="sidebar__actions">
            <button
              class="sidebar__button"
              id="new-chat-button"
              title="New Chat"
              aria-label="Start a new conversation"
            >
              <i class="fas fa-plus"></i>
            </button>
            <button
              class="sidebar__button"
              id="load-conversations-button"
              title="Load Conversations"
              aria-label="Load previous conversations"
            >
              <i class="fas fa-history"></i>
            </button>
            <button
              class="sidebar__button"
              id="logout-button"
              title="Logout"
              aria-label="Logout"
            >
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
        </header>
        <section class="chat-messages" id="chat-messages">
          <div class="typing-indicator hidden" id="typing-indicator">
            Bot is typing...
          </div>
          <div
            class="loading-previous-messages hidden"
            id="loading-previous-messages"
          >
            <div class="loading-spinner"></div>
          </div>
          <!-- Chat messages will be loaded here -->
        </section>
        <footer class="chat-input-area">
          <form class="input-area" id="chat-form">
            <textarea
              class="input-area__input chat-input"
              id="chat-input"
              placeholder="Type a message..."
              aria-label="Chat input"
              required
            ></textarea>
            <button
              type="submit"
              class="input-area__button send-button"
              id="send-button"
              aria-label="Send message"
            >
              Send <i class="fas fa-paper-plane"></i>
            </button>
          </form>
        </footer>
      </main>
    </div>
    <div class="auth-container" id="auth-container">
      <div class="error-message hidden" id="auth-error-display"></div>
      <div class="auth-container__form-wrapper" id="signup-form-div">
        <h2 class="auth-container__title">Sign Up</h2>
        <form id="signup-form" class="auth-form">
          <div class="auth-form__group form-group">
            <label class="form-group__label" for="signup-username"
              >Username</label
            >
            <input
              class="form-group__input"
              type="text"
              id="signup-username"
              name="username"
              required
              aria-required="true"
            />
          </div>
          <div class="auth-form__group form-group">
            <label class="form-group__label" for="signup-email">Email</label>
            <input
              class="form-group__input"
              type="email"
              id="signup-email"
              name="email"
              required
              aria-required="true"
            />
          </div>
          <div class="auth-form__group form-group">
            <label class="form-group__label" for="signup-password"
              >Password</label
            >
            <input
              class="form-group__input"
              type="password"
              id="signup-password"
              name="password"
              required
              aria-required="true"
            />
          </div>
          <button type="submit" class="auth-form__button auth-button">
            Sign Up
          </button>
          <p class="auth-form__switch-text auth-switch-text">
            Already have an account? <a href="#" id="toggle-login">Login</a>
          </p>
        </form>
      </div>
      <div class="auth-container__form-wrapper hidden" id="login-form-div">
        <h2 class="auth-container__title">Login</h2>
        <form id="login-form" class="auth-form">
          <div class="auth-form__group form-group">
            <label class="form-group__label" for="login-email">Email</label>
            <input
              class="form-group__input"
              type="email"
              id="login-email"
              name="email"
              required
              aria-required="true"
            />
          </div>
          <div class="auth-form__group form-group">
            <label class="form-group__label" for="login-password"
              >Password</label
            >
            <input
              class="form-group__input"
              type="password"
              id="login-password"
              name="password"
              required
              aria-required="true"
            />
          </div>
          <button type="submit" class="auth-form__button auth-button">
            Login
          </button>
          <p class="auth-form__switch-text auth-switch-text">
            <a href="#" id="toggle-signup">Create an account</a> |
            <a href="#" id="forgot-password">Forgot password?</a>
          </p>
        </form>
      </div>

      <div class="auth-container__form-wrapper hidden" id="forgot-password-div">
        <h2 class="auth-container__title">Forgot Password</h2>
        <form id="forgot-password-form" class="auth-form">
          <div class="auth-form__group form-group">
            <label class="form-group__label" for="forgot-email">
              Enter your Email
            </label>
            <input
              class="form-group__input"
              type="email"
              name="forgot-email"
              id="forgot-email"
              required
              aria-required="true"
            />
          </div>
          <button type="submit" class="auth-form__button auth-button">
            Send Reset Email
          </button>
          <p class="auth-form__switch-text auth-switch-text">
            <a href="#" id="toggle-login-from-forgot">Back to login</a>
          </p>
        </form>
      </div>

      <div class="auth-container__form-wrapper hidden" id="reset-password-div">
        <h2 class="auth-container__title">Reset your password</h2>
        <form id="reset-password-form" class="auth-form">
          <div class="auth-form__group form-group">
            <label class="form-group__label" for="reset-password">
              New Password
            </label>
            <input
              class="form-group__input"
              type="password"
              id="reset-password"
              name="reset-password"
              required
              aria-required="true"
            />
          </div>
          <button type="submit" class="auth-form__button auth-button">
            Reset Password
          </button>
        </form>
      </div>
    </div>
    <div class="overlay hidden" id="loading-overlay">
      <div class="loading-spinner"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
      hljs.highlightAll();
      // Your JavaScript remains largely the same
      const chatApp = document.getElementById("chat-app");
      const authContainer = document.getElementById("auth-container");
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");
      const chatMessages = document.getElementById("chat-messages");
      const loadingOverlay = document.getElementById("loading-overlay");
      const authErrorDisplay = document.getElementById("auth-error-display");
      const sendButton = document.getElementById("send-button");
      const newChatButton = document.getElementById("new-chat-button");
      const typingIndicator = document.getElementById("typing-indicator");
      const logoutButton = document.getElementById("logout-button");
      const sidebar = document.getElementById("chat-sidebar");
      const sidebarToggle = document.getElementById("sidebar-toggle");

      const signupForm = document.getElementById("signup-form");
      const loginForm = document.getElementById("login-form");
      const signupFormDiv = document.getElementById("signup-form-div");
      const loginFormDiv = document.getElementById("login-form-div");

      const forgotPasswordDiv = document.getElementById("forgot-password-div");
      const forgotPasswordForm = document.getElementById(
        "forgot-password-form"
      );
      const resetPasswordForm = document.getElementById("reset-password-form");
      const resetPasswordDiv = document.getElementById("reset-password-div");
      const toggleLoginLink = document.getElementById("toggle-login");
      const toggleSignupLink = document.getElementById("toggle-signup");
      const forgotPasswordLink = document.getElementById("forgot-password");
      const toggleLoginFromForgot = document.getElementById(
        "toggle-login-from-forgot"
      );

      const verifyEmailOverlay = document.getElementById(
        "verify-email-overlay"
      );
      const loadConversationsButton = document.getElementById(
        "load-conversations-button"
      );

      const conversationList = document.getElementById("conversation-list");
      const loadingPreviousMessages = document.getElementById(
        "loading-previous-messages"
      );
      const verifyEmailText = document.getElementById("verify_email_text");
      const closeVerifyEmailButton =
        document.getElementById("close-verify-email");

      let authToken = localStorage.getItem("authToken");
      const socket = new WebSocket("ws://192.168.43.45:8765");
      let selectedConversationId = null;

      closeVerifyEmailButton.addEventListener("click", () => {
        verifyEmailOverlay.classList.add("hidden");
      });

      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }
      const tokenType = getQueryParam("type");
      const emailVerificationToken = getQueryParam("token");
      const resetPasswordToken = getQueryParam("token");

      socket.onopen = () => {
        console.log("Connected to WebSocket server.");
        if (authToken) {
          console.log("Sending stored auth token:", authToken);
          socket.send(JSON.stringify({ userId: authToken }));
          authContainer.classList.add("hidden");
          chatApp.classList.remove("hidden");
          // Load conversations immediately
          if (window.innerWidth > 768) {
            socket.send(
              JSON.stringify({ action: "load_previous_conversations" })
            );
          }
        } else if (tokenType === "verify" && emailVerificationToken) {
          console.log(
            "Email verification token found in URL:",
            emailVerificationToken
          );
          socket.send(
            JSON.stringify({
              action: "verify_email",
              token: emailVerificationToken,
            })
          );
        } else if (tokenType === "reset" && resetPasswordToken) {
          console.log("Reset password token found in URL:", resetPasswordToken);
          signupFormDiv.classList.add("hidden");
          loginFormDiv.classList.add("hidden");
          forgotPasswordDiv.classList.add("hidden");
          resetPasswordDiv.classList.remove("hidden");
        } else {
          authContainer.classList.remove("hidden");
          chatApp.classList.add("hidden");
        }
      };
      socket.onmessage = (event) => {
        try {
          const responseData = JSON.parse(event.data);
          const messageType = responseData.type;
          const messageContent = responseData.message;
          const errorType = responseData.error_type;
          const conversationId = responseData.conversationId;

          console.log("Received from server:", responseData);

          if (messageType === "connection_success") {
            const userId = responseData.userId;
            console.log("Connection Successful, userId:", userId);
            authToken = userId;
            localStorage.setItem("authToken", userId);
            authContainer.classList.add("hidden");
            chatApp.classList.remove("hidden");
            hideLoading();
            // Load conversations immediately
            if (window.innerWidth > 768) {
              socket.send(
                JSON.stringify({ action: "load_previous_conversations" })
              );
            }
          } else if (messageType === "status" && messageContent === "typing") {
            showTypingIndicator();
          } else if (messageType === "new_chat_success") {
            console.log("new chat success conversation id", conversationId);
            selectedConversationId = conversationId;
            chatMessages.innerHTML = "";
            hideLoading();
            toggleButtonLoading(false);
          } else if (messageType === "bot") {
            addMessageToChat(
              messageContent,
              "bot",
              false,
              null,
              null,
              conversationId
            );
            hideLoading();
            hideTypingIndicator();
            toggleButtonLoading(false);
          } else if (messageType === "previous_conversations") {
            displayConversationList(responseData.conversations);
            hideLoading();
            toggleButtonLoading(false);
          } else if (messageType === "conversation_messages") {
            hideLoading();
            chatMessages.innerHTML = "";
            selectedConversationId = responseData.conversationId;
            if (responseData.messages) {
              responseData.messages.forEach((msg) => {
                addMessageToChat(
                  msg.message,
                  msg.type,
                  false,
                  msg.id,
                  msg.timestamp,
                  responseData.conversationId
                );
              });
            }
            toggleButtonLoading(false);
          } else if (messageType === "message_edited") {
            const messageId = responseData.messageId;
            const newMessage = responseData.newMessage;
            updateMessage(messageId, newMessage);
          } else if (messageType === "message_deleted") {
            const messageId = responseData.messageId;
            deleteMessageFromUI(messageId);
          } else if (messageType === "signup_success") {
            const userId = responseData.userId;
            console.log("SignUp Successful userId:", userId);
            authToken = userId;
            localStorage.setItem("authToken", userId);
            authContainer.classList.add("hidden");
            chatApp.classList.remove("hidden");
            hideLoading();
          } else if (messageType === "login_success") {
            const userId = responseData.userId;
            console.log("Login Successful userId:", userId);
            authToken = userId;
            localStorage.setItem("authToken", userId);
            authContainer.classList.add("hidden");
            chatApp.classList.remove("hidden");
            hideLoading();
            // Load conversations immediately
            if (window.innerWidth > 768) {
              socket.send(
                JSON.stringify({ action: "load_previous_conversations" })
              );
            }
          } else if (messageType === "verify_email_success") {
            verifyEmailOverlay.classList.remove("hidden");
            verifyEmailText.innerText = messageContent;
            authErrorDisplay.classList.add("hidden");
          } else if (messageType === "forgot_password_success") {
            displayAuthMessage(messageContent);
            hideLoading();
          } else if (messageType === "reset_password_success") {
            resetPasswordDiv.classList.add("hidden");
            loginFormDiv.classList.remove("hidden");
            displayAuthMessage(messageContent);
            hideLoading();
          } else if (messageType === "error") {
            displayError(messageContent, errorType);
            hideLoading();
            hideTypingIndicator();
            toggleButtonLoading(false);

            if (
              errorType === "signup_error" ||
              errorType === "login_error" ||
              errorType === "forgot_password_error" ||
              errorType === "reset_password_error" ||
              errorType === "verify_email_error"
            ) {
              displayAuthError(messageContent, errorType);
            }
          } else {
            console.warn(
              "Unrecognised message type:",
              messageType,
              responseData
            );
          }
        } catch (error) {
          console.error("Error handling message:", error);
        }
      };
      const passwordRegex =
        /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }
      signupForm.addEventListener("submit", (e) => {
        e.preventDefault();
        authErrorDisplay.classList.add("hidden");
        const username = document.getElementById("signup-username").value;
        const email = document.getElementById("signup-email").value;
        const password = document.getElementById("signup-password").value;
        if (!username.trim()) {
          displayAuthError("Username field is required", "signup_error");
          return;
        }
        if (!isValidEmail(email)) {
          displayAuthError(
            "Please provide a valid email format",
            "signup_error"
          );
          return;
        }
        if (!passwordRegex.test(password)) {
          displayAuthError(
            "Password must be 8 chars long min, have one uppercase, one lowercase and one special character",
            "signup_error"
          );
          return;
        }
        showLoading();
        console.log(`Attempting signup payload`, {
          username: username,
          email: email,
          password: password,
        });
        const signupPayload = {
          action: "signup",
          username: username,
          email: email,
          password: password,
        };
        socket.send(JSON.stringify(signupPayload));
        signupForm.reset();
      });
      loginForm.addEventListener("submit", (e) => {
        e.preventDefault();
        authErrorDisplay.classList.add("hidden");
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;

        if (!isValidEmail(email)) {
          displayAuthError(
            "Please provide a valid email format",
            "login_error"
          );
          return;
        }
        if (!password.trim()) {
          displayAuthError("Password field is required", "login_error");
          return;
        }
        showLoading();
        console.log(`Attempting login payload`, {
          email: email,
          password: password,
        });
        const loginPayload = {
          action: "login",
          email: email,
          password: password,
        };
        socket.send(JSON.stringify(loginPayload));
        loginForm.reset();
      });
      forgotPasswordForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const forgotEmail = document.getElementById("forgot-email").value;
        authErrorDisplay.classList.add("hidden");
        if (!isValidEmail(forgotEmail)) {
          displayAuthError(
            "Please provide a valid email format",
            "forgot_password_error"
          );
          return;
        }
        showLoading();
        console.log("Attempting forgot password request:", {
          email: forgotEmail,
        });

        const forgotPasswordPayload = {
          action: "forgot_password",
          email: forgotEmail,
        };
        socket.send(JSON.stringify(forgotPasswordPayload));
        forgotPasswordForm.reset();
      });

      resetPasswordForm.addEventListener("submit", (e) => {
        e.preventDefault();
        authErrorDisplay.classList.add("hidden");
        const newPassword = document.getElementById("reset-password").value;

        if (!passwordRegex.test(newPassword)) {
          displayAuthError(
            "Password must be 8 chars long min, have one uppercase, one lowercase and one special character",
            "reset_password_error"
          );
          return;
        }
        const token = getQueryParam("token");
        showLoading();
        const resetPasswordPayload = {
          action: "reset_password",
          newPassword: newPassword,
          token: token,
        };

        console.log("Reset Payload:", resetPasswordPayload);

        socket.send(JSON.stringify(resetPasswordPayload));
        resetPasswordForm.reset();
      });

      function addMessageToChat(
        message,
        type,
        isPrepended = false,
        messageId = null,
        timestamp = null,
        conversationId = null
      ) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message");
        messageDiv.classList.add(
          type === "user" ? "message--user" : "message--bot"
        );
        if (messageId) {
          messageDiv.dataset.messageId = messageId;
        }
        if (conversationId) {
          messageDiv.dataset.conversationId = conversationId;
        }

        const messageContentDiv = document.createElement("div");
        messageContentDiv.innerHTML = message;

        const timestampSpan = document.createElement("span");
        timestampSpan.classList.add("message__timestamp");
        timestampSpan.textContent = timestamp
          ? moment(timestamp).format("LT")
          : moment().format("LT");

        const actionsDiv = document.createElement("div");
        actionsDiv.classList.add("message__actions");

        if (type === "user") {
          const editBtn = createActionButton("fas fa-edit", () =>
            editMessage(messageDiv, messageContentDiv, message)
          );
          const deleteBtn = createActionButton("fas fa-trash", () =>
            deleteMessage(messageDiv)
          );
          actionsDiv.appendChild(editBtn);
          actionsDiv.appendChild(deleteBtn);
        }
        const copyBtn = createActionButton("fas fa-copy", () =>
          copyToClipboard(messageContentDiv.innerText)
        );
        copyBtn.classList.add("message__copy-button");
        messageDiv.appendChild(messageContentDiv);
        messageDiv.appendChild(timestampSpan);
        messageDiv.appendChild(actionsDiv);
        messageDiv.appendChild(copyBtn);
        // Highlight code blocks
        messageContentDiv
          .querySelectorAll("pre code")
          .forEach(hljs.highlightBlock);

        if (isPrepended) {
          chatMessages.insertBefore(messageDiv, chatMessages.firstChild);
        } else {
          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }

      function createActionButton(iconClass, onClick) {
        const button = document.createElement("button");
        button.innerHTML = `<i class="${iconClass}"></i>`;
        button.addEventListener("click", onClick);
        return button;
      }

      function editMessage(messageDiv, messageContent, currentMessage) {
        const textarea = document.createElement("textarea");
        textarea.value = currentMessage;
        textarea.classList.add("chat-input");
        textarea.style.width = "calc(100% - 20px)"; // Adjust width for padding
        textarea.style.minHeight = "50px";
        textarea.style.boxSizing = "border-box";

        const saveButton = document.createElement("button");
        saveButton.textContent = "Save";
        saveButton.classList.add("send-button");
        saveButton.onclick = () => {
          const newMessage = textarea.value;
          const messageId = messageDiv.dataset.messageId;
          if (messageId) {
            socket.send(
              JSON.stringify({
                action: "edit_message",
                messageId: messageId,
                newMessage: newMessage,
              })
            );
          } else {
            messageContent.innerHTML = newMessage;
          }
          messageDiv.innerHTML = "";
          messageDiv.appendChild(messageContent);
          messageDiv.appendChild(createTimestampSpan());
          messageDiv.appendChild(
            createActionsDivForUserMessage(messageContent, newMessage)
          );
        };

        messageDiv.innerHTML = "";
        messageDiv.appendChild(textarea);
        messageDiv.appendChild(saveButton);
      }

      function createTimestampSpan(timestamp) {
        const timestampSpan = document.createElement("span");
        timestampSpan.classList.add("message__timestamp");
        timestampSpan.textContent = timestamp
          ? moment(timestamp).format("LT")
          : moment().format("LT");
        return timestampSpan;
      }
      function createActionsDivForUserMessage(messageContent, currentMessage) {
        const actionsDiv = document.createElement("div");
        actionsDiv.classList.add("message__actions");
        const editBtn = createActionButton("fas fa-edit", () =>
          editMessage(actionsDiv.parentElement, messageContent, currentMessage)
        );
        const deleteBtn = createActionButton("fas fa-trash", () =>
          deleteMessage(actionsDiv.parentElement)
        );
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        return actionsDiv;
      }
      function updateMessage(messageId, newMessage) {
        const messageDiv = chatMessages.querySelector(
          `[data-message-id="${messageId}"]`
        );
        if (messageDiv) {
          messageDiv.querySelector(".message div:first-child").innerHTML =
            newMessage;
        }
      }

      function deleteMessage(messageDiv) {
        const messageId = messageDiv.dataset.messageId;
        if (messageId) {
          socket.send(
            JSON.stringify({ action: "delete_message", messageId: messageId })
          );
        } else {
          messageDiv.remove();
        }
      }
      function deleteMessageFromUI(messageId) {
        const messageDiv = chatMessages.querySelector(
          `[data-message-id="${messageId}"]`
        );
        if (messageDiv) {
          messageDiv.remove();
        }
      }

      function showLoading() {
        loadingOverlay.classList.remove("hidden");
      }
      function hideLoading() {
        loadingOverlay.classList.add("hidden");
      }

      function showTypingIndicator() {
        typingIndicator.classList.remove("hidden");
      }
      function hideTypingIndicator() {
        typingIndicator.classList.add("hidden");
      }
      function displayAuthError(message, errorType) {
        authErrorDisplay.textContent = message;
        authErrorDisplay.classList.remove("hidden");
        setTimeout(() => {
          authErrorDisplay.classList.add("hidden");
        }, 5000);
      }
      function displayAuthMessage(message) {
        authErrorDisplay.textContent = message;
        authErrorDisplay.classList.remove("hidden");
        setTimeout(() => {
          authErrorDisplay.classList.add("hidden");
        }, 5000);
      }
      function displayError(message, errorType) {
        const errorDiv = document.createElement("div");
        errorDiv.classList.add("error-message");
        errorDiv.textContent = message;
        chatMessages.appendChild(errorDiv);
        setTimeout(() => {
          errorDiv.remove();
        }, 5000);
      }
      function toggleButtonLoading(isLoading) {
        sendButton.disabled = isLoading;
        sendButton.innerHTML = isLoading
          ? '<div class="loading-spinner"></div>'
          : 'Send <i class="fas fa-paper-plane"></i>';
      }

      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          console.log("Message copied to clipboard!");
        } catch (err) {
          console.error("Failed to copy message: ", err);
        }
      }
      toggleLoginLink.addEventListener("click", (e) => {
        e.preventDefault();
        signupFormDiv.classList.add("hidden");
        loginFormDiv.classList.remove("hidden");
        forgotPasswordDiv.classList.add("hidden");
        resetPasswordDiv.classList.add("hidden");
      });
      toggleSignupLink.addEventListener("click", (e) => {
        e.preventDefault();
        signupFormDiv.classList.remove("hidden");
        loginFormDiv.classList.add("hidden");
        forgotPasswordDiv.classList.add("hidden");
        resetPasswordDiv.classList.add("hidden");
      });
      forgotPasswordLink.addEventListener("click", (e) => {
        e.preventDefault();
        signupFormDiv.classList.add("hidden");
        loginFormDiv.classList.add("hidden");
        forgotPasswordDiv.classList.remove("hidden");
        resetPasswordDiv.classList.add("hidden");
      });
      toggleLoginFromForgot.addEventListener("click", (e) => {
        e.preventDefault();
        signupFormDiv.classList.add("hidden");
        loginFormDiv.classList.remove("hidden");
        forgotPasswordDiv.classList.add("hidden");
        resetPasswordDiv.classList.add("hidden");
      });

      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (message) {
          const payload = { action: "send_message", message: message };
          console.log("Sending message payload:", payload);
          socket.send(JSON.stringify(payload));
          addMessageToChat(
            message,
            "user",
            false,
            null,
            null,
            selectedConversationId
          );
          chatInput.value = "";
          toggleButtonLoading(true);
        }
      });

      newChatButton.addEventListener("click", () => {
        socket.send(JSON.stringify({ action: "new_chat" }));
        chatMessages.innerHTML = "";
        selectedConversationId = null;
        // Remove selection from previous conversations in the sidebar
        document
          .querySelectorAll("#conversation-list li")
          .forEach((li) => li.classList.remove("selected"));
      });

      loadConversationsButton.addEventListener("click", () => {
        socket.send(JSON.stringify({ action: "load_previous_conversations" }));
      });

      sidebarToggle.addEventListener("click", () => {
        socket.send(JSON.stringify({ action: "load_previous_conversations" }));
      });

      function displayConversationList(conversations) {
        conversationList.innerHTML = "";
        conversations.forEach((conversation) => {
          const listItem = document.createElement("li");
          const conversationName =
            conversation.name ||
            `Conversation ${moment(conversation.startTime).format(
              "MMM DD, h:mm A"
            )}`;
          listItem.textContent =
            conversationName.length > 19
              ? conversationName.substring(0, 19) + "..."
              : conversationName;
          listItem.addEventListener("click", () => {
            loadConversation(conversation.id);
            // Remove selection from other list items
            document
              .querySelectorAll("#conversation-list li")
              .forEach((li) => li.classList.remove("selected"));
            // Add selection to the clicked item
            listItem.classList.add("selected");
            // Close sidebar on mobile after selecting conversation
            if (window.innerWidth <= 768) {
              sidebar.classList.remove("open");
            }
          });
          conversationList.appendChild(listItem);
        });
      }
      function loadConversation(conversationId) {
        showLoading();
        socket.send(
          JSON.stringify({
            action: "load_conversation",
            conversationId: conversationId,
          })
        );
      }

      logoutButton.addEventListener("click", () => {
        localStorage.removeItem("authToken");
        authToken = null;
        chatApp.classList.add("hidden");
        authContainer.classList.remove("hidden");
        authErrorDisplay.classList.add("hidden");
        chatMessages.innerHTML = "";
        selectedConversationId = null;
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({ action: "logout" }));
        }
      });

      // Mobile sidebar toggle functionality
      sidebarToggle.addEventListener("click", () => {
        sidebar.classList.toggle("open");
      });

      // Close sidebar when clicking outside on mobile
      document.addEventListener("click", (event) => {
        if (
          window.innerWidth <= 768 &&
          sidebar.classList.contains("open") &&
          !event.target.closest(".sidebar") &&
          !event.target.closest(".sidebar-toggle-button")
        ) {
          sidebar.classList.remove("open");
        }
      });

      // Prevent clicks inside the sidebar from closing it
      sidebar.addEventListener("click", (event) => {
        if (window.innerWidth <= 768) {
          event.stopPropagation();
        }
      });
    </script>
  </body>
</html>
